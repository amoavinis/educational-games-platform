rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Role checking functions
    function isAdmin() {
      return request.auth.token.role == 1;
    }
    
    function isSchoolUser() {
      return request.auth.token.role == 2;
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function belongsToUsersSchool() {
      return resource.data.schoolId == request.auth.uid;
    }

    match /students/{studentId} {
      // CREATE rules
      allow create: if isAuthenticated() && (
                      isAdmin() || 
                      (isSchoolUser() && 
                       request.resource.data.schoolId == request.auth.uid)
                    );

      // UPDATE rules
      allow update: if isAuthenticated() && (
                     isAdmin() ||
                     (isSchoolUser() && 
                      belongsToUsersSchool() &&
                      request.resource.data.schoolId == request.auth.uid)
                   );

      // READ rules
      allow read: if isAuthenticated() && (
                    isAdmin() ||
                    (isSchoolUser() && belongsToUsersSchool())
                  );

      // DELETE rules
      allow delete: if isAuthenticated() && (
                      isAdmin() ||
                      (isSchoolUser() && belongsToUsersSchool())
                    );
    }
  }
}