rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Role checking functions
    function isAdmin() {
      return request.auth.token.role == 1;
    }
    
    function isSchoolUser() {
      return request.auth.token.role == 2;
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function belongsToUsersSchool() {
      return resource.data.schoolId == request.auth.uid;
    }
    
    function belongsToUsersSchoolInRequest() {
      return request.resource.data.schoolId == request.auth.uid;
    }

    match /students/{studentId} {
      // CREATE rules
      allow create: if isAuthenticated() && (
                      isAdmin() || 
                      (isSchoolUser() && belongsToUsersSchoolInRequest())
                    );

      // UPDATE rules
      allow update: if isAuthenticated() && (
                     isAdmin() ||
                     (isSchoolUser() && 
                      belongsToUsersSchool() &&
                      belongsToUsersSchoolInRequest())
                   );

      // READ rules
      allow get: if isAuthenticated() && (
                   isAdmin() ||
                   (isSchoolUser() && belongsToUsersSchool())
                 );
                 
      allow list: if isAuthenticated() && (
                    isAdmin() ||
                    (isSchoolUser() && request.auth.uid != null)
                  );

      // DELETE rules
      allow delete: if isAuthenticated() && (
                      isAdmin() ||
                      (isSchoolUser() && belongsToUsersSchool())
                    );
    }

    match /schools/{schoolId} {
      allow create, update, delete: if isAuthenticated() && isAdmin();
      allow read: if isAuthenticated() && (
                     isAdmin() || 
                     (schoolId == request.auth.uid && request.auth.token.role == 2)
                   );
    }
    
    match /classes/{classId} {
      // Same pattern as students
      allow create: if isAuthenticated() && (
                      isAdmin() || 
                      (isSchoolUser() && belongsToUsersSchoolInRequest())
                    );

      allow update: if isAuthenticated() && (
                     isAdmin() ||
                     (isSchoolUser() && 
                      belongsToUsersSchool() &&
                      belongsToUsersSchoolInRequest())
                   );

      allow get: if isAuthenticated() && (
                   isAdmin() ||
                   (isSchoolUser() && belongsToUsersSchool())
                 );
                 
      allow list: if isAuthenticated() && (
                    isAdmin() ||
                    (isSchoolUser() && request.auth.uid != null)
                  );
                       
      allow delete: if isAuthenticated() && (
                      isAdmin() ||
                      (isSchoolUser() && belongsToUsersSchool())
                    );
    }
    
    match /reports/{reportId} {
      // Reports can be created by authenticated users
      allow create: if isAuthenticated() && (
                      isAdmin() || 
                      isSchoolUser()
                    );

      // Reports can be read by authenticated users
      allow get: if isAuthenticated() && (
                   isAdmin() ||
                   isSchoolUser()
                 );
                 
      allow list: if isAuthenticated() && (
                    isAdmin() ||
                    isSchoolUser()
                  );

      // Reports can be updated and deleted by authenticated users
      allow update, delete: if isAuthenticated() && (
                      isAdmin() ||
                      isSchoolUser()
                    );
    }
  }
}